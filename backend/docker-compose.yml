# 1. 核心思路：混合运行 (Hybrid Run)
# Docker 负责基础设施：MySQL, Redis (不需要显卡，安装麻烦，用 Docker 最好)。
# 本机运行 Python 代码：Django Web, Celery Worker (直接调用宿主机 3080 显卡，环境配置最简单)。

# docker-compose.yml (本地开发专用版)
version: '3.8'

services:
  # MySQL数据库
  db:
    image: mysql:8.0
    container_name: skillspace_container_db
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME} # 初始化时创建的数据库名称
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD} # root管理员密码
      MYSQL_USER: ${DB_USER}             # 初始化时创建的用户名
      MYSQL_PASSWORD: ${DB_PASSWORD}     # 初始化时创建的用户密码
    ports:
      - "3306:3306" # 暴露端口，供本机 Django 连接
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - skillspace_net


  # 2. Redis 缓存 (兼作 Celery Backend)
  redis:
    image: redis:6.2
    container_name: skillspace_redis
    restart: always
    # 启动时设置密码
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
    # 容器名 代IP地址
      - skillspace_net


  # 3. RabbitMQ 消息队列 (Celery Broker)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: skillspace_rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "5672:5672"   # 消息通讯端口
      - "15672:15672" # 管理后台端口 (浏览器访问)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - skillspace_net

  # 4. Celery Worker (异步任务处理)
  celery_worker:
    build: .
    container_name: skillspace_worker
    restart: always
    depends_on:
      - db
      - redis
      - rabbitmq
    # 启动 Celery
    command: celery -A SkillSpace worker --loglevel=info
    volumes:
      - .:/app
    env_file:
      - .env
    # ⚠️ 注意：如果不做 GPU 穿透，这里的 Worker 只能用 CPU 跑 AI
    networks:
      - skillspace_net

# 数据卷持久化
volumes:
  mysql_data:
  redis_data:
  rabbitmq_data:

# 自定义网络，保证容器间可通过服务名互通
networks:
  skillspace_net:
    driver: bridge
  # 5. Django Web 服务
  # web:
  #   build: .
  #   container_name: skillspace_web
  #   restart: always
  #   # 等待基础服务启动后再启动
  #   depends_on:
  #     - db
  #     - redis
  #     - rabbitmq
  #   # 启动命令：先迁移数据库，再启动服务
  #   command: >
  #     sh -c "python manage.py migrate &&
  #            python manage.py runserver 0.0.0.0:8000"
  #   volumes:
  #     - .:/app
  #   ports:
  #     - "8000:8000"
  #   # 加载环境变量
  #   env_file:
  #     - .env
  #   networks:
  #     - skillspace_net







