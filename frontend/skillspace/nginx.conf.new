# ==================== 限流配置区（放在http块或server块外）====================
# 注意：这些配置需要放在 server 块之前

# 1. 登录接口限流（防止暴力破解）
# 规则：同一IP每秒最多2次请求，突发允许5次，超出则延迟处理
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=2r/s;

# 2. AI接口限流（防止token盗刷 - 严格）
# 规则：同一IP每秒最多1次请求，突发允许2次，超出直接拒绝
limit_req_zone $binary_remote_addr zone=ai_limit:10m rate=1r/s;

# 3. 普通API限流（防止CC攻击 - 宽松）
# 规则：同一IP每秒最多20次请求，突发允许50次
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;

# 4. WebSocket连接数限制
# 规则：同一IP最多10个并发WebSocket连接
limit_conn_zone $binary_remote_addr zone=ws_conn_limit:10m;

# 5. 全局连接数限制（防止大规模CC攻击）
# 规则：同一IP最多50个并发连接
limit_conn_zone $binary_remote_addr zone=global_conn_limit:10m;

# ==================== 限流日志配置 ====================
# 当请求被限流时，记录日志级别（默认error，改为warn减少日志噪音）
limit_req_log_level warn;
limit_conn_log_level warn;

# 返回的HTTP状态码（默认503，改为429更语义化）
limit_req_status 429;
limit_conn_status 429;


server {
    listen 80;
    server_name localhost;

    # ==================== 全局连接数限制 ====================
    # 应用到整个server块
    limit_conn global_conn_limit 50;

    # 前端静态文件根目录
    root /usr/share/nginx/html;
    index index.html;

    # Gzip 压缩配置（提升传输速度）
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/x-javascript application/xml+rss
               application/json application/javascript;

    # ==================== 前端路由配置 ====================
    # Vue Router 的 History 模式支持
    # 所有找不到的文件都返回 index.html，由前端路由接管
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ==================== 登录接口限流（严格） ====================
    location ~ ^/api/auth/(login|register)/ {
        # 限流配置：每秒2次，突发5次，超出延迟处理（nodelay改为delay）
        limit_req zone=login_limit burst=5;

        # 限流触发时返回自定义响应头（便于调试）
        add_header X-RateLimit-Limit "2 per second" always;

        # 代理到后端
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ==================== AI接口限流（非常严格，防止token盗刷） ====================
    location ~ ^/api/ai/(chat|qwen|message)/ {
        # 限流配置：每秒1次，突发2次，超出直接拒绝（nodelay）
        limit_req zone=ai_limit burst=2 nodelay;

        # 限流响应头
        add_header X-RateLimit-Limit "1 per second" always;
        add_header X-RateLimit-Burst "2" always;

        # 代理到后端
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # AI接口可能需要更长的超时时间
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ==================== 普通API限流（宽松，不影响正常使用） ====================
    location /api/ {
        # 限流配置：每秒20次，突发50次，超出延迟处理
        limit_req zone=api_limit burst=50;

        # 限流响应头
        add_header X-RateLimit-Limit "20 per second" always;

        # 代理到后端
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ==================== WebSocket 代理（限制连接数） ====================
    # AI 助手实时对话使用的 WebSocket 连接
    location /ws/ {
        # 限制同一IP的WebSocket并发连接数
        limit_conn ws_conn_limit 10;

        # 限流响应头
        add_header X-Conn-Limit "10 concurrent connections" always;

        proxy_pass http://backend:8000;

        # WebSocket 必须的配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 其他请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # WebSocket 超时设置（保持长连接）
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ==================== Django 静态文件代理 ====================
    # Django Admin 和 SimpleUI 的静态资源（不限流）
    location /static/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
    }

    # Django 上传的媒体文件（不限流）
    location /media/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
    }

    # ==================== 安全配置 ====================
    # 禁止访问隐藏文件（如 .git, .env）
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 静态资源缓存配置（提升性能，不限流）
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==================== 自定义限流错误页面（可选） ====================
    # 当触发限流时，返回友好的错误信息
    error_page 429 /429.html;
    location = /429.html {
        internal;
        default_type application/json;
        return 429 '{"code":429,"message":"请求过于频繁，请稍后再试","error":"Too Many Requests"}';
    }
}
