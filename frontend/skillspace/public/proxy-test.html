<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite ä»£ç†æµ‹è¯•é¡µé¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .test-section {
      margin-bottom: 25px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .test-section h2 {
      font-size: 18px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-section h2::before {
      content: 'ğŸ§ª';
      font-size: 24px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }

    .result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .result.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.success { background: #28a745; }
    .status-indicator.error { background: #dc3545; }
    .status-indicator.pending { background: #ffc107; }

    .checklist {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 6px;
    }

    .checklist h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }

    .checklist ul {
      list-style: none;
      padding-left: 0;
    }

    .checklist li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .checklist li:last-child {
      border-bottom: none;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .badge.ready { background: #d4edda; color: #155724; }
    .badge.not-ready { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Vite ä»£ç†é…ç½®æµ‹è¯•</h1>
    <p class="subtitle">æµ‹è¯•å‰åç«¯è¿æ¥å’Œä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®</p>

    <!-- æµ‹è¯• 1: åç«¯å¥åº·æ£€æŸ¥ -->
    <div class="test-section">
      <h2>æµ‹è¯• 1: åç«¯æœåŠ¡å¥åº·æ£€æŸ¥</h2>
      <button onclick="testBackendHealth()">è¿è¡Œæµ‹è¯•</button>
      <div id="health-result"></div>
    </div>

    <!-- æµ‹è¯• 2: API ä»£ç† -->
    <div class="test-section">
      <h2>æµ‹è¯• 2: HTTP API ä»£ç†</h2>
      <button onclick="testApiProxy()">è¿è¡Œæµ‹è¯•</button>
      <div id="api-result"></div>
    </div>

    <!-- æµ‹è¯• 3: CORS å’Œ Cookie -->
    <div class="test-section">
      <h2>æµ‹è¯• 3: CORS å’Œ Cookie</h2>
      <button onclick="testCors()">è¿è¡Œæµ‹è¯•</button>
      <div id="cors-result"></div>
    </div>

    <!-- æµ‹è¯• 4: WebSocket -->
    <div class="test-section">
      <h2>æµ‹è¯• 4: WebSocket ä»£ç†</h2>
      <button onclick="testWebSocket()">è¿è¡Œæµ‹è¯•</button>
      <div id="ws-result"></div>
    </div>

    <!-- é…ç½®æ£€æŸ¥æ¸…å• -->
    <div class="checklist">
      <h3>ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•</h3>
      <ul id="checklist">
        <li>
          <span class="status-indicator pending"></span>
          åç«¯æœåŠ¡è¿è¡Œåœ¨ localhost:8000
          <span class="badge not-ready" id="badge-backend">æœªæ£€æµ‹</span>
        </li>
        <li>
          <span class="status-indicator pending"></span>
          Vite ä»£ç†é…ç½®æ­£ç¡®
          <span class="badge not-ready" id="badge-proxy">æœªæ£€æµ‹</span>
        </li>
        <li>
          <span class="status-indicator pending"></span>
          CORS é…ç½®æ­£ç¡®
          <span class="badge not-ready" id="badge-cors">æœªæ£€æµ‹</span>
        </li>
        <li>
          <span class="status-indicator pending"></span>
          WebSocket è¿æ¥æ­£å¸¸
          <span class="badge not-ready" id="badge-ws">æœªæ£€æµ‹</span>
        </li>
      </ul>
    </div>
  </div>

  <script>
    // æµ‹è¯• 1: åç«¯å¥åº·æ£€æŸ¥
    async function testBackendHealth() {
      const resultDiv = document.getElementById('health-result');
      resultDiv.innerHTML = '<div class="result info">â³ æ­£åœ¨æ£€æµ‹åç«¯æœåŠ¡...</div>';

      try {
        const response = await fetch('/api/auth/me/', {
          method: 'GET',
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok || response.status === 401) {
          resultDiv.innerHTML = `
            <div class="result success">
              âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼

çŠ¶æ€ç : ${response.status}
å“åº”: ${JSON.stringify(data, null, 2)}
            </div>
          `;
          updateBadge('badge-backend', true);
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="result error">
            âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥ï¼

é”™è¯¯: ${error.message}

è¯·æ£€æŸ¥:
1. åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ï¼ˆlocalhost:8000ï¼‰
2. Vite ä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®
          </div>
        `;
        updateBadge('badge-backend', false);
      }
    }

    // æµ‹è¯• 2: API ä»£ç†
    async function testApiProxy() {
      const resultDiv = document.getElementById('api-result');
      resultDiv.innerHTML = '<div class="result info">â³ æµ‹è¯• API ä»£ç†...</div>';

      try {
        // æ•…æ„è°ƒç”¨ä¸€ä¸ªä¸éœ€è¦è®¤è¯çš„æ¥å£ï¼ˆæˆ–401ä¹Ÿæ˜¯æ­£å¸¸çš„ï¼‰
        const response = await fetch('/api/auth/login/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: 'test-proxy',
            password: 'test-proxy'
          }),
          credentials: 'include'
        });

        const data = await response.json();

        // åªè¦èƒ½æ”¶åˆ°å“åº”å°±è¯´æ˜ä»£ç†æ­£å¸¸ï¼ˆå³ä½¿æ˜¯400é”™è¯¯ï¼‰
        if (response.status === 400 || response.status === 401 || response.status === 200) {
          resultDiv.innerHTML = `
            <div class="result success">
              âœ… API ä»£ç†å·¥ä½œæ­£å¸¸ï¼

è¯·æ±‚è·¯å¾„: /api/auth/login/
çŠ¶æ€ç : ${response.status}
å“åº”: ${JSON.stringify(data, null, 2)}

è¯´æ˜: ä»£ç†å·²å°†è¯·æ±‚è½¬å‘åˆ° http://localhost:8000
            </div>
          `;
          updateBadge('badge-proxy', true);
        } else {
          throw new Error(`æ„å¤–çš„çŠ¶æ€ç : ${response.status}`);
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="result error">
            âŒ API ä»£ç†æµ‹è¯•å¤±è´¥ï¼

é”™è¯¯: ${error.message}

å¯èƒ½åŸå› :
1. Vite ä»£ç†æœªæ­£ç¡®é…ç½®
2. åç«¯æœåŠ¡æœªå¯åŠ¨
3. ç«¯å£é…ç½®é”™è¯¯ï¼ˆåº”è¯¥æ˜¯ 8000ï¼‰
          </div>
        `;
        updateBadge('badge-proxy', false);
      }
    }

    // æµ‹è¯• 3: CORS å’Œ Cookie
    async function testCors() {
      const resultDiv = document.getElementById('cors-result');
      resultDiv.innerHTML = '<div class="result info">â³ æµ‹è¯• CORS å’Œ Cookie...</div>';

      try {
        // å‘é€è¯·æ±‚å¹¶æ£€æŸ¥ Cookie
        const response = await fetch('/api/auth/me/', {
          method: 'GET',
          credentials: 'include'
        });

        // æ£€æŸ¥ Cookie
        const cookies = document.cookie;
        const hasCsrfToken = cookies.includes('csrftoken');
        const hasSessionId = cookies.includes('sessionid');

        resultDiv.innerHTML = `
          <div class="result ${hasCsrfToken ? 'success' : 'info'}">
            ${hasCsrfToken ? 'âœ…' : 'â„¹ï¸'} CORS é…ç½®æ­£å¸¸

Cookie çŠ¶æ€:
- csrftoken: ${hasCsrfToken ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨ï¼ˆåˆ·æ–°é¡µé¢ååº”è¯¥ä¼šæœ‰ï¼‰'}
- sessionid: ${hasSessionId ? 'âœ… å­˜åœ¨' : 'âš ï¸ ä¸å­˜åœ¨ï¼ˆç™»å½•åä¼šç”Ÿæˆï¼‰'}

å½“å‰ Cookie:
${cookies || 'ï¼ˆæ— ï¼‰'}

è¯´æ˜: credentials: 'include' å·²ç”Ÿæ•ˆ
          </div>
        `;
        updateBadge('badge-cors', true);
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="result error">
            âŒ CORS æµ‹è¯•å¤±è´¥ï¼

é”™è¯¯: ${error.message}

è¯·æ£€æŸ¥:
1. åç«¯ CORS_ALLOW_CREDENTIALS = True
2. è¯·æ±‚æºå¸¦ credentials: 'include'
          </div>
        `;
        updateBadge('badge-cors', false);
      }
    }

    // æµ‹è¯• 4: WebSocket
    async function testWebSocket() {
      const resultDiv = document.getElementById('ws-result');
      resultDiv.innerHTML = '<div class="result info">â³ æµ‹è¯• WebSocket è¿æ¥...</div>';

      try {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/ai/test-connection/`;

        resultDiv.innerHTML = `
          <div class="result info">
            â³ æ­£åœ¨è¿æ¥ WebSocket...

è¿æ¥åœ°å€: ${wsUrl}
          </div>
        `;

        const ws = new WebSocket(wsUrl);

        // è®¾ç½®è¶…æ—¶
        const timeout = setTimeout(() => {
          ws.close();
          resultDiv.innerHTML = `
            <div class="result error">
              â±ï¸ WebSocket è¿æ¥è¶…æ—¶ï¼ˆ5ç§’ï¼‰

å¯èƒ½åŸå› :
1. åç«¯ WebSocket æœåŠ¡æœªå¯åŠ¨
2. Channels æœªæ­£ç¡®é…ç½®
3. Vite WebSocket ä»£ç†æœªé…ç½®

å»ºè®®:
- ç¡®ä¿ä½¿ç”¨ Daphne å¯åŠ¨åç«¯ï¼ˆæ”¯æŒ WebSocketï¼‰
- æ£€æŸ¥ vite.config.js ä¸­ /ws ä»£ç†é…ç½®
            </div>
          `;
          updateBadge('badge-ws', false);
        }, 5000);

        ws.onopen = () => {
          clearTimeout(timeout);
          resultDiv.innerHTML = `
            <div class="result success">
              âœ… WebSocket è¿æ¥æˆåŠŸï¼

è¿æ¥åœ°å€: ${wsUrl}
åè®®: ${ws.protocol || 'WebSocket'}
å°±ç»ªçŠ¶æ€: ${ws.readyState} (OPEN)

è¯´æ˜: Vite WebSocket ä»£ç†å·¥ä½œæ­£å¸¸
            </div>
          `;
          updateBadge('badge-ws', true);
          ws.close();
        };

        ws.onerror = (error) => {
          clearTimeout(timeout);
          resultDiv.innerHTML = `
            <div class="result error">
              âŒ WebSocket è¿æ¥å¤±è´¥ï¼

é”™è¯¯: ${error.message || 'è¿æ¥é”™è¯¯'}

è¯·æ£€æŸ¥:
1. åç«¯ä½¿ç”¨ Daphne å¯åŠ¨ï¼ˆä¸æ˜¯ runserverï¼‰
2. Channels é…ç½®æ­£ç¡®
3. vite.config.js ä¸­ /ws ä»£ç†å·²é…ç½®
4. ä»£ç†é…ç½®åŒ…å« ws: true
            </div>
          `;
          updateBadge('badge-ws', false);
        };

        ws.onclose = (event) => {
          if (!event.wasClean) {
            clearTimeout(timeout);
            resultDiv.innerHTML = `
              <div class="result error">
                âŒ WebSocket è¿æ¥å¼‚å¸¸å…³é—­

å…³é—­ä»£ç : ${event.code}
å…³é—­åŸå› : ${event.reason || 'æœªçŸ¥'}
              </div>
            `;
            updateBadge('badge-ws', false);
          }
        };

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="result error">
            âŒ WebSocket æµ‹è¯•å¤±è´¥ï¼

é”™è¯¯: ${error.message}
          </div>
        `;
        updateBadge('badge-ws', false);
      }
    }

    // æ›´æ–°å¾½ç« çŠ¶æ€
    function updateBadge(badgeId, success) {
      const badge = document.getElementById(badgeId);
      if (success) {
        badge.textContent = 'âœ… æ­£å¸¸';
        badge.className = 'badge ready';
      } else {
        badge.textContent = 'âŒ å¼‚å¸¸';
        badge.className = 'badge not-ready';
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    window.onload = () => {
      console.log('ğŸ”§ å½“å‰ç¯å¢ƒä¿¡æ¯:');
      console.log('å‰ç«¯åœ°å€:', window.location.origin);
      console.log('é¢„æœŸåç«¯åœ°å€: http://localhost:8000');
      console.log('Cookie:', document.cookie || 'ï¼ˆæ— ï¼‰');
    };
  </script>
</body>
</html>
