name: Build and Push to ACR

# 触发条件：推送到指定分支时自动执行
on:
  push:
    branches:
      - main
      - master
      - feature/**  # 支持所有 feature 分支
  # 也可以手动触发工作流
  workflow_dispatch:

env:
  # 镜像版本号（使用 Git commit SHA 短码）
  IMAGE_TAG: ${{ github.sha }}
  # 从 GitHub Secrets 读取 ACR 配置
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}

jobs:
  build-and-push:
    name: 构建并推送 Docker 镜像到 ACR
    runs-on: ubuntu-latest

    steps:
      # ==================== 1. 检出代码 ====================
      - name: 检出代码
        uses: actions/checkout@v4

      # ==================== 2. 设置 Docker Buildx ====================
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ==================== 3. 登录阿里云 ACR ====================
      - name: 登录阿里云容器镜像服务
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ==================== 4. 构建并推送后端镜像 ====================
      - name: 构建并推送后端镜像
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/skillspace/backend:latest
            ${{ secrets.ACR_REGISTRY }}/skillspace/backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/skillspace/backend:latest
          cache-to: type=inline

      # ==================== 5. 构建并推送 Celery Worker 镜像 ====================
      - name: 构建并推送 Celery Worker 镜像
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/skillspace/celery_worker:latest
            ${{ secrets.ACR_REGISTRY }}/skillspace/celery_worker:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/skillspace/celery_worker:latest
          cache-to: type=inline

      # ==================== 6. 构建并推送前端镜像 ====================
      - name: 构建并推送前端镜像
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/skillspace
          file: ./frontend/skillspace/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/skillspace/frontend:latest
            ${{ secrets.ACR_REGISTRY }}/skillspace/frontend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/skillspace/frontend:latest
          cache-to: type=inline

      # ==================== 7. 输出构建信息 ====================
      - name: 输出构建信息
        run: |
          echo "========================================="
          echo "✅ 镜像构建并推送成功！"
          echo "========================================="
          echo "镜像标签："
          echo "  - backend:latest"
          echo "  - backend:${{ github.sha }}"
          echo "  - celery_worker:latest"
          echo "  - celery_worker:${{ github.sha }}"
          echo "  - frontend:latest"
          echo "  - frontend:${{ github.sha }}"
          echo "========================================="
          echo "下一步操作："
          echo "1. SSH 连接到 ECS 服务器"
          echo "2. 执行: cd /app/skillspace"
          echo "3. 执行: docker compose -f docker-compose.prod.yml pull"
          echo "4. 执行: docker compose -f docker-compose.prod.yml up -d"
          echo "========================================="
