# ========================================
# SkillSpace é¡¹ç›®æŒç»­é›†æˆå·¥ä½œæµé…ç½®
# CI/CD Pipeline for SkillSpace Project
# ========================================
# æŠ€æœ¯æ ˆï¼š
#   å‰ç«¯ï¼šVue 3 + Vite
#   åŽç«¯ï¼šDjango + DRF + MySQL + Redis
#   çŽ¯å¢ƒï¼šUbuntu Latest
# ========================================

name: SkillSpace CI/CD Pipeline

# ========================================
# å·¥ä½œæµè§¦å‘æ¡ä»¶
# ========================================
on:
  # ä»…æŽ¨æ ¸å¿ƒåˆ†æ”¯ï¼ˆmain/hotfix/*ï¼‰æ—¶è§¦å‘pushäº‹ä»¶ï¼ˆé¿å…featureåˆ†æ”¯é¢‘ç¹pushè§¦å‘CIï¼‰
  push:
    branches: [ "main", "hotfix/*" ]
  # æ‰€æœ‰å‘ã€Œmain/feature/*/fix/*/hotfix/*ã€æPRæ—¶è§¦å‘ï¼ˆè¦†ç›–æ‰€æœ‰å¼€å‘åœºæ™¯ï¼‰
  pull_request:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ========================================
# å…¨å±€çŽ¯å¢ƒå˜é‡
# ========================================
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '20'
  FRONTEND_BUILD_DIR: frontend/skillspace/dist
  BACKEND_DIR: backend

jobs:
  # ========================================
  # ä½œä¸š1ï¼šå‰ç«¯æµ‹è¯•å’Œæž„å»º
  # ========================================
  frontend-test-build:
    name: å‰ç«¯æµ‹è¯•ä¸Žæž„å»º (Vue 3)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/skillspace
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

            # === æ·»åŠ è¿™ä¸€è¡Œæ¥éªŒè¯ ===
      - name: ðŸš© èº«ä»½éªŒè¯
        run: echo "æˆ‘æ˜¯æ–°ç‰ˆæœ¬çš„CIæ–‡ä»¶ï¼ï¼ï¼ç‰ˆæœ¬å· v2.0.3-grep-a"

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json
      
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit
      
      # é¢„ç•™ï¼šä»£ç æ£€æŸ¥ä¸Žå•å…ƒæµ‹è¯•
      # - run: npm run lint
      # - run: npm run test:unit
      
      - name: ðŸ—ï¸ æž„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: npm run build
      
      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 7

  # ========================================
  # ä½œä¸š2ï¼šåŽç«¯æµ‹è¯• (é›†æˆ MySQL & Redis)
  # ========================================
  backend-test:
    name: åŽç«¯æµ‹è¯• (Django + MySQL)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    
    # ---------------------------------------------------
    # å®šä¹‰æœåŠ¡å®¹å™¨ (Service Containers)
    # GitHub Actions ä¼šè‡ªåŠ¨å¯åŠ¨è¿™äº› Docker å®¹å™¨å¹¶æ˜ å°„ç«¯å£
    # ---------------------------------------------------
    services:
      # MySQL 8.0 æœåŠ¡
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_skillspace
        ports:
          - 3306:3306
        # å¥åº·æ£€æŸ¥ï¼šç¡®ä¿æ•°æ®åº“å°±ç»ªåŽå†è¿è¡ŒåŽç»­æ­¥éª¤
        options: >-
          --health-cmd "mysqladmin ping -h localhost"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Redis æœåŠ¡ (ç”¨äºŽ Celery æµ‹è¯•)
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ðŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      # ---------------------------------------------------
      # å®‰è£…ä¾èµ– (ç²¾ç¡®å‰”é™¤ torch ç›¸å…³åŒ…çš„å£°æ˜Žï¼ˆåªåŒ¹é…ä»¥ torch å¼€å¤´çš„åŒ…ï¼‰,å« PyTorch CPU ç‰ˆä¿®å¤)
      # ---------------------------------------------------
      # - name: ðŸ“¦ å®‰è£…åŽç«¯ä¾èµ–
      #   run: |
      #     echo "å‡çº§pip..."
      #     python -m pip install --upgrade pip
          
      #     echo "ðŸ”§ æ­£åœ¨é€‚é… CI çŽ¯å¢ƒ (ä½¿ç”¨CPUç‰ˆPyTorch)..."
      #     # 1. ä»Ž requirements.txt ä¸­ç§»é™¤ GPU ç‰ˆ torch
      #     sed -i '/torch==/d' requirements.txt
      #     sed -i '/torchvision==/d' requirements.txt
      #     sed -i '/torchaudio==/d' requirements.txt
          
      #     # 2. æ‰‹åŠ¨å®‰è£… CPU ç‰ˆæœ¬ PyTorch (åŠ é€Ÿ CI ä¸‹è½½)
      #     pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu
          
      #     echo "å®‰è£…å…¶ä»–ä¾èµ–..."
      #     pip install -r requirements.txt

      - name: ðŸ“¦ å®‰è£…åŽç«¯ä¾èµ–
        run: |
          set -e  # å‘½ä»¤æ‰§è¡Œå¤±è´¥ç«‹å³ç»ˆæ­¢ï¼Œä¾¿äºŽå®šä½é—®é¢˜
          echo "å‡çº§ pip..."
          python -m pip install --upgrade pip
          
          echo "ðŸ”§ ç²¾å‡†å‰”é™¤ requirements.txt ä¸­çš„ Torch ç›¸å…³åŒ…å£°æ˜Ž..."
          # åªåˆ é™¤ torch/torchvision/torchaudio åŒ…å£°æ˜Žè¡Œï¼Œä¸å½±å“å…¶ä»–ä¾èµ–
          grep -a -Ev "^(torch|torchvision|torchaudio)($|=|>|<|~)" requirements.txt > requirements.ci.txt
          
          # éªŒè¯è¿‡æ»¤ç»“æžœï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
          echo "ðŸ“„ è¿‡æ»¤åŽçš„ requirements.ci.txt å†…å®¹ï¼š"
          cat requirements.ci.txt
          
          # å®‰è£… CPU ç‰ˆ PyTorchï¼ˆé¿å… CUDA é©±åŠ¨ä¾èµ–ï¼‰
          echo "â¬‡ï¸ å®‰è£… PyTorch (CPU ç‰ˆ)..."
          pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu
          
          # å®‰è£…å…¶ä½™é¡¹ç›®ä¾èµ–ï¼ˆå« Django ç­‰æ ¸å¿ƒä¾èµ–ï¼‰
          echo "â¬‡ï¸ å®‰è£…é¡¹ç›®å…¶ä½™ä¾èµ–..."
          pip install -r requirements.ci.txt
          
          # ã€å…³é”®ã€‘å®‰è£… pymysqlï¼ˆæ›¿ä»£ mysqlclientï¼‰ï¼Œæ— éœ€ pkgconfig
          echo "â¬‡ï¸ å®‰è£… pymysql é©±åŠ¨..."
          pip install pymysql
          
          # ã€æ ¸å¿ƒã€‘æ³¨å†Œ pymysql åˆ° Djangoï¼ˆå¿…é¡»æ­¥éª¤ï¼Œå¦åˆ™æ•°æ®åº“è¿žæŽ¥å¤±è´¥ï¼‰
          echo "ðŸ”§ æ³¨å†Œ pymysql ä½œä¸º MySQL é©±åŠ¨..."
          # æ–¹å¼1ï¼šç›´æŽ¥åœ¨ CI ä¸­ä¿®æ”¹ Django é…ç½®ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€æ”¹æºç ï¼‰
          # å‘ Django ä¸»é…ç½®æ–‡ä»¶å¤´éƒ¨æ’å…¥ pymysql æ³¨å†Œä»£ç 
          sed -i '1i import pymysql\npymysql.install_as_MySQLdb()' SkillSpace/settings.py
          
          # éªŒè¯å®‰è£…ç»“æžœï¼ˆç¡®è®¤æ ¸å¿ƒä¾èµ–éƒ½è£…å¥½ï¼‰
          echo "âœ… éªŒè¯æ ¸å¿ƒä¾èµ–å®‰è£…ï¼š"
          python -c "import django; print('Django ç‰ˆæœ¬:', django.get_version())"
          python -c "import torch; print('Torch ç‰ˆæœ¬:', torch.__version__); print('Torch CUDA å¯ç”¨:', torch.cuda.is_available())"
          python -c "import pymysql; print('pymysql ç‰ˆæœ¬:', pymysql.__version__)"
          
          echo "âœ… ä¾èµ–å®‰è£… & é©±åŠ¨é…ç½®å®Œæˆ"

      # ---------------------------------------------------
      # é…ç½®çŽ¯å¢ƒå˜é‡ (è¿žæŽ¥ Service å®¹å™¨)
      # ---------------------------------------------------
      - name: âš™ï¸ é…ç½®æµ‹è¯•çŽ¯å¢ƒå˜é‡
        run: |
          cat > .env << EOF
          # --- åŸºç¡€é…ç½® ---
          DEBUG=False
          SECRET_KEY=ci-test-secret-key-must-be-long-enough
          
          # --- å…³é”®ï¼šæ ‡è¯†æµ‹è¯•æ¨¡å¼ (ç”¨äºŽ Mock AI æ¨¡åž‹) ---
          TESTING_MODE=True
          
          # --- æ•°æ®åº“é…ç½® (è¿žæŽ¥ MySQL Service) ---
          # æ³¨æ„ï¼šService åœ¨ GitHub Actions ä¸­æ˜ å°„åˆ° localhost
          DB_ENGINE=django.db.backends.mysql
          DB_NAME=test_skillspace
          DB_USER=root
          DB_PASSWORD=root
          DB_HOST=127.0.0.1
          DB_PORT=3306
          
          # --- Celery é…ç½® ---
          CELERY_BROKER_URL=redis://localhost:6379/0
          CELERY_RESULT_BACKEND=redis://localhost:6379/0
          EOF
          
          echo "âœ… çŽ¯å¢ƒå˜é‡å·²æ³¨å…¥ (.env)"

      # - name: ðŸ§ éªŒè¯Djangoå®‰è£…
      #   run: |
      #       python -c "import django; print('Djangoç‰ˆæœ¬:', django.get_version())"

      - name: ðŸ” Django ç³»ç»Ÿæ£€æŸ¥
        run: python manage.py check

      - name: ðŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»
        run: |
          # è¿™ä¸€æ­¥éªŒè¯äº†èƒ½å¦æˆåŠŸè¿žæŽ¥åˆ° MySQL å®¹å™¨
          python manage.py migrate

      - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        # ä½¿ç”¨ä¸» settingsï¼Œé…åˆçŽ¯å¢ƒå˜é‡å·¥ä½œ
        run: python manage.py test --verbosity=2
        env:
          DJANGO_SETTINGS_MODULE: SkillSpace.settings

  # ========================================
  # ä½œä¸š3ï¼šä»£ç è´¨é‡æ£€æŸ¥ (å¹¶è¡Œ)
  # ========================================
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ” è¿è¡Œæ£€æŸ¥ (å ä½)
        run: echo "æ­¤å¤„é›†æˆ Flake8 / Black / ESLint"

  # ========================================
  # ä½œä¸š4ï¼šæž„å»ºæˆåŠŸé€šçŸ¥
  # ========================================
  build-success:
    name: âœ… æž„å»ºæˆåŠŸ
    runs-on: ubuntu-latest
    needs: [frontend-test-build, backend-test, code-quality]
    steps:
      - name: ðŸŽ‰ é€šçŸ¥
        run: echo "CI Pipeline å…¨éƒ¨é€šè¿‡ï¼Œå‡†å¤‡å°±ç»ªï¼"

# ========================================
# CD æŒç»­éƒ¨ç½²æž¶æž„å»ºè®® (ä¿ç•™ä¾›å‚è€ƒ)
# ========================================
# 
#  deploy-production:
#    if: github.ref == 'refs/heads/main'
#    needs: build-success
#    ... (æ­¤å¤„ä¿ç•™ä½ åŽŸæ–‡ä»¶ä¸­çš„ CD é…ç½®æ³¨é‡Šï¼Œä¸åšæ”¹åŠ¨) ...