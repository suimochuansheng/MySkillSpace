# ========================================
# SkillSpace é¡¹ç›®æŒç»­é›†æˆå·¥ä½œæµé…ç½®
# CI/CD Pipeline for SkillSpace Project
# ========================================
# æŠ€æœ¯æ ˆï¼š
#   å‰ç«¯ï¼šVue 3 + Vite
#   åç«¯ï¼šDjango + DRF + MySQL + Redis
#   ç¯å¢ƒï¼šUbuntu Latest
# ========================================

# å·¥ä½œæµåç§°ï¼šå°†æ˜¾ç¤ºåœ¨ GitHub Actions ç•Œé¢ä¸Š
name: SkillSpace CI/CD Pipeline

# ========================================
# å·¥ä½œæµè§¦å‘æ¡ä»¶
# ========================================
on:
  push:
    branches: [ "main", "hotfix/*" ]
  pull_request:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  workflow_dispatch:

# ========================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ========================================
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '20'
  FRONTEND_BUILD_DIR: frontend/skillspace/dist
  BACKEND_DIR: backend

# ========================================
# ä½œä¸šå®šä¹‰
# ========================================
jobs:
  # ========================================
  # ä½œä¸š1ï¼šå‰ç«¯æµ‹è¯•å’Œæ„å»º
  # ========================================
  frontend-test-build:
    name: å‰ç«¯æµ‹è¯•ä¸æ„å»º (Vue 3)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/skillspace

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json
      
      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…Vueã€Element Plusç­‰å‰ç«¯ä¾èµ–..."
          npm ci --prefer-offline --no-audit
          echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯ç”Ÿäº§ç‰ˆæœ¬
        run: |
          echo "å¼€å§‹æ„å»ºViteç”Ÿäº§ç‰ˆæœ¬..."
          npm run build
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆï¼Œè¾“å‡ºç›®å½•: dist/"
      
      - name: ğŸ“¤ ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 7
          if-no-files-found: error

  # ========================================
  # ä½œä¸š2ï¼šåç«¯æµ‹è¯•å’Œæ£€æŸ¥
  # ========================================
  backend-test:
    name: åç«¯æµ‹è¯•ä¸æ£€æŸ¥ (Django + settings.py)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          # æš‚æ—¶ç¦ç”¨æ–‡ä»¶è·¯å¾„æ£€æŸ¥ï¼Œé¿å…å› ç¼–ç ä¿®å¤å¯¼è‡´Hashä¸åŒ¹é…
          # cache-dependency-path: backend/requirements.txt
      
      # ========================================================
      # æ ¸å¿ƒä¿®å¤æ­¥éª¤ï¼šè§£å†³ requirements.txt ç¼–ç å¯¼è‡´ä¾èµ–æ¼è£…çš„é—®é¢˜
      # ========================================================
      - name: ğŸ“¦ å®‰è£…åç«¯ä¾èµ– (å«ç¼–ç è‡ªåŠ¨ä¿®å¤)
        run: |
          set -e
          echo "å‡çº§ pip..."
          python -m pip install --upgrade pip
          
          echo "ğŸ”§ [ä¿®å¤] æ­£åœ¨æ£€æŸ¥å¹¶ä¿®å¤ requirements.txt ç¼–ç ..."
          
          # ä½¿ç”¨ Python è„šæœ¬å°† UTF-16 (Windows) è½¬æ¢ä¸º UTF-8
          python << 'EOF'
          import os
          file_path = "requirements.txt"
          
          try:
              # 1. å°è¯•ä»¥ UTF-16 è¯»å– (å¤„ç† PowerShell ç”Ÿæˆçš„æ–‡ä»¶)
              with open(file_path, "r", encoding="utf-16") as f:
                  content = f.read()
              print("âœ… æ£€æµ‹åˆ° UTF-16 ç¼–ç ï¼Œå·²è¯»å–ã€‚")
          except UnicodeError:
              # 2. å¦‚æœå¤±è´¥ï¼Œå°è¯•ä»¥ UTF-8 è¯»å–
              with open(file_path, "r", encoding="utf-8") as f:
                  content = f.read()
              print("âœ… æ£€æµ‹åˆ° UTF-8 ç¼–ç ï¼Œå·²è¯»å–ã€‚")
          except Exception as e:
              print(f"âš ï¸ è¯»å–å‡ºé”™: {e}")
              exit(1)
          
          # 3. é‡æ–°å†™å…¥ä¸ºæ—  BOM çš„æ ‡å‡† UTF-8
          with open(file_path, "w", encoding="utf-8") as f:
              f.write(content)
          print("âœ… æ–‡ä»¶å·²è½¬æ¢ä¸ºæ ‡å‡† UTF-8 æ ¼å¼")
          EOF
          
          echo "ğŸ”§ ç²¾å‡†å‰”é™¤ requirements.txt ä¸­çš„ Torch ç›¸å…³åŒ…å£°æ˜..."
          # ç°åœ¨æ–‡ä»¶æ˜¯çº¯å‡€çš„ UTF-8ï¼Œgrep å¯ä»¥æ­£å¸¸å·¥ä½œ
          grep -Ev "^(torch|torchvision|torchaudio)($|=|>|<|~)" requirements.txt > requirements.ci.txt
          
          # éªŒè¯æ–‡ä»¶å†…å®¹ï¼ˆç¡®ä¿ä¸æ˜¯ç©ºæ–‡ä»¶ï¼‰
          echo "ğŸ“„ æ£€æŸ¥ä¾èµ–åˆ—è¡¨å‰10è¡Œ:"
          head -n 10 requirements.ci.txt
          
          echo "â¬‡ï¸ å®‰è£… PyTorch (CPU ç‰ˆ)..."
          pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu
          
          echo "â¬‡ï¸ å®‰è£…é¡¹ç›®å…¶ä½™ä¾èµ–..."
          pip install -r requirements.ci.txt
          
          echo "â¬‡ï¸ å®‰è£… pymysql é©±åŠ¨..."
          pip install pymysql
          
          echo "ğŸ”§ æ³¨å†Œ pymysql..."
          # å³ä½¿ä½¿ç”¨ SQLite æµ‹è¯•ï¼Œæ³¨å†Œé©±åŠ¨ä¹Ÿèƒ½é˜²æ­¢ä»£ç ä¸­ import æŠ¥é”™
          sed -i '1i import pymysql\npymysql.install_as_MySQLdb()' SkillSpace/settings.py
          
          echo "âœ… éªŒè¯æ ¸å¿ƒä¾èµ–å®‰è£…ï¼š"
          # éªŒè¯ Django æ˜¯å¦æˆåŠŸå®‰è£…
          python -c "import django; print('Django ç‰ˆæœ¬:', django.get_version())"

      - name: âš™ï¸ é…ç½®æµ‹è¯•ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰
        run: |
          cat > .env << EOF
          CELERY_BROKER_URL=redis://localhost:6379/0
          CELERY_RESULT_BACKEND=redis://localhost:6379/0
          EOF
          echo "âœ… ç¯å¢ƒå˜é‡å·²é…ç½®"

      - name: ğŸ” Djangoç³»ç»Ÿæ£€æŸ¥
        run: python manage.py check --settings=SkillSpace.settings

      - name: ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»
        run: |
          echo "å¼€å§‹æ•°æ®åº“è¿ç§»ï¼ˆSQLite å†…å­˜æ•°æ®åº“ï¼‰..."
          python manage.py migrate --settings=SkillSpace.settings --verbosity=2
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

      - name: ğŸ§ª è¿è¡Œåç«¯å•å…ƒæµ‹è¯•
        run: |
          echo "å¼€å§‹è¿è¡Œ Django å•å…ƒæµ‹è¯•..."
          python manage.py test --settings=SkillSpace.settings --verbosity=2
          echo "âœ… æµ‹è¯•å®Œæˆ"

  # ========================================
  # ä½œä¸š3ï¼šä»£ç è´¨é‡æ£€æŸ¥
  # ========================================
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ” è¿è¡Œæ£€æŸ¥ (å ä½)
        run: echo "æ­¤å¤„é›†æˆ Flake8 / Black / ESLint"

  # ========================================
  # ä½œä¸š4ï¼šæ„å»ºæˆåŠŸé€šçŸ¥
  # ========================================
  build-success:
    name: âœ… æ„å»ºæˆåŠŸ
    runs-on: ubuntu-latest
    needs: [frontend-test-build, backend-test, code-quality]
    steps:
      - name: ğŸ‰ é€šçŸ¥
        run: echo "CI Pipeline å…¨éƒ¨é€šè¿‡ï¼Œå‡†å¤‡å°±ç»ªï¼"

# ========================================
# CD æŒç»­éƒ¨ç½²æ¶æ„å»ºè®® (ä¿ç•™ä¾›å‚è€ƒ)
# ========================================
# 
#  deploy-production:
#    if: github.ref == 'refs/heads/main'
#    needs: build-success
#    ...