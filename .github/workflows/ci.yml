# ========================================
# SkillSpace é¡¹ç›® CI/CD é…ç½®
# ç›®æ ‡ï¼šå»ºç«‹ç¨³å®šå¯é çš„åŸºç¡€æµ‹è¯•æµç¨‹
# ========================================

name: SkillSpace CI Pipeline

# ========================================
# è§¦å‘æ¡ä»¶
# ========================================
on:
  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æˆ– hotfix åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ "main", "hotfix/*" ]
  
  # å½“åˆ›å»ºæˆ–æ›´æ–° Pull Request æ—¶è§¦å‘
  pull_request:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ========================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ========================================
env:
  # Python ç‰ˆæœ¬ï¼šå…¼å®¹ Django 5.x
  PYTHON_VERSION: '3.9'
  
  # Node.js ç‰ˆæœ¬ï¼šä½¿ç”¨ LTS ç‰ˆæœ¬
  NODE_VERSION: '20'
  
  # å‰ç«¯æ„å»ºè¾“å‡ºç›®å½•
  FRONTEND_BUILD_DIR: frontend/skillspace/dist

# ========================================
# ä½œä¸šå®šä¹‰
# å‰ç«¯å’Œåç«¯ä½œä¸šå¹¶è¡Œæ‰§è¡Œï¼Œæé«˜ CI æ•ˆç‡
# ========================================
jobs:
  # ============================
  # ä½œä¸š 1ï¼šå‰ç«¯æµ‹è¯•å’Œæ„å»º
  # ============================
  frontend-test-build:
    name: å‰ç«¯æµ‹è¯•ä¸æ„å»º (Vue 3 + Vite)
    runs-on: ubuntu-latest
    
    # è®¾ç½®é»˜è®¤å·¥ä½œç›®å½•
    defaults:
      run:
        working-directory: frontend/skillspace
    
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤ 2ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # å¯ç”¨ npm ç¼“å­˜åŠ é€Ÿä¾èµ–å®‰è£…
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json

      # æ­¥éª¤ 3ï¼šå®‰è£…å‰ç«¯ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£… Vue3 + Element Plus ç­‰ä¾èµ–..."
          # ä½¿ç”¨ npm ci ç¡®ä¿ä¸ package-lock.json å®Œå…¨ä¸€è‡´
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # æ­¥éª¤ 4ï¼šVite æ„å»ºæ£€æŸ¥
      - name: ğŸ› ï¸ Vite æ„å»ºæ£€æŸ¥
        run: |
          echo "å¼€å§‹ Vite æ„å»º..."
          npm run build
          echo "âœ… æ„å»ºæˆåŠŸï¼Œè¾“å‡ºç›®å½•: dist/"
      
      # æ­¥éª¤ 5ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 7
          if-no-files-found: error

  # ============================
  # ä½œä¸š 2ï¼šåç«¯æµ‹è¯•
  # ============================
  backend-test:
    name: åç«¯æµ‹è¯• (Django + settings_test.py)
    runs-on: ubuntu-latest
    
    # è®¾ç½®é»˜è®¤å·¥ä½œç›®å½•
    defaults:
      run:
        working-directory: backend
    
    # é…ç½®æœåŠ¡å®¹å™¨ï¼šRedisï¼ˆç”¨äº Celery æµ‹è¯•ï¼‰
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤ 2ï¼šè®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # å¯ç”¨ pip ç¼“å­˜åŠ é€Ÿä¾èµ–å®‰è£…
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      # æ­¥éª¤ 3ï¼šå®‰è£…åç«¯ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å‡çº§ pip..."
          python -m pip install --upgrade pip
          
          echo "å¤„ç†æ–‡ä»¶ç¼–ç ï¼ˆå¦‚éœ€ï¼‰..."
          # å°è¯•è½¬æ¢ UTF-16 åˆ° UTF-8ï¼ˆWindows ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
          python << 'EOF'
          try:
              content = open('requirements.txt', 'r', encoding='utf-16').read()
              open('requirements.txt', 'w', encoding='utf-8').write(content)
              print('âœ… æ–‡ä»¶ç¼–ç è½¬æ¢æˆåŠŸ')
          except:
              print('â„¹ï¸ æ–‡ä»¶æ— éœ€è½¬æ¢')
          EOF
          
          echo "è¿‡æ»¤ PyTorch åŒ…ï¼ˆä½¿ç”¨ CPU ç‰ˆæœ¬ï¼‰..."
          # ä» requirements.txt ä¸­è¿‡æ»¤æ‰ torch ç›¸å…³åŒ…
          grep -Ev "^(torch|torchvision|torchaudio)" requirements.txt > requirements.ci.txt || true
          
          echo "å®‰è£… PyTorch CPU ç‰ˆæœ¬..."
          pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu
          
          echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
          pip install -r requirements.ci.txt
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # æ­¥éª¤ 4ï¼šé…ç½®æµ‹è¯•ç¯å¢ƒå˜é‡
      - name: âš™ï¸ é…ç½®ç¯å¢ƒå˜é‡
        run: |
          # åˆ›å»º .env æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œsettings_test.py å·²æä¾›é»˜è®¤å€¼ï¼‰
          cat > .env << EOF
          # å¯é€‰ï¼šä½¿ç”¨çœŸå® Redis
          CELERY_BROKER_URL=redis://localhost:6379/0
          CELERY_RESULT_BACKEND=redis://localhost:6379/0
          EOF
          echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

      # æ­¥éª¤ 5ï¼šDjango ç³»ç»Ÿæ£€æŸ¥
      - name: ğŸ” Django ç³»ç»Ÿæ£€æŸ¥
        run: |
          echo "æ‰§è¡Œ Django ç³»ç»Ÿæ£€æŸ¥..."
          python manage.py check --settings=SkillSpace.settings_test
          echo "âœ… ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"

      # æ­¥éª¤ 6ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»
      - name: ğŸ—„ï¸ æ•°æ®åº“è¿ç§»
        run: |
          echo "æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆSQLite å†…å­˜æ¨¡å¼ï¼‰..."
          python manage.py migrate --settings=SkillSpace.settings_test --verbosity=2
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

      # æ­¥éª¤ 7ï¼šè¿è¡Œå•å…ƒæµ‹è¯•
      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          echo "è¿è¡Œ Django å•å…ƒæµ‹è¯•..."
          python manage.py test --settings=SkillSpace.settings_test --verbosity=2
          echo "âœ… æµ‹è¯•å®Œæˆ"
