# ========================================
# SkillSpace é¡¹ç›® CI/CD é…ç½®
# ç›®æ ‡ï¼šå»ºç«‹ç¨³å®šå¯é çš„åŸºç¡€æµ‹è¯•æµç¨‹
# ========================================

name: SkillSpace CI Pipeline

# ========================================
# è§¦å‘æ¡ä»¶
# ========================================
on:
  push:
    branches: [ "main", "hotfix/*" ]
  pull_request:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  workflow_dispatch:

# ========================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ========================================
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '20'
  FRONTEND_BUILD_DIR: frontend/skillspace/dist
  # æ–°å¢ï¼šæ¨¡å‹æµ‹è¯•æ ‡è®°
  SKIP_MODEL_TESTS: "true"  # CIç¯å¢ƒé»˜è®¤è·³è¿‡æ¨¡å‹åŠ è½½æµ‹è¯•

# ========================================
# ä½œä¸šå®šä¹‰
# ========================================
jobs:
  frontend-test-build:
    name: å‰ç«¯æµ‹è¯•ä¸æ„å»º (Vue 3 + Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/skillspace
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ› ï¸ Vite æ„å»ºæ£€æŸ¥
        run: |
          echo "å¼€å§‹æ„å»º..."
          npm run build
          echo "âœ… æ„å»ºæˆåŠŸ"
      
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 7
          if-no-files-found: error

  backend-test:
    name: åç«¯æµ‹è¯• (Django + settings_test.py)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          
          # ç¼–ç è½¬æ¢å¢å¼ºï¼šå…ˆæ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
          if [ -f "requirements.txt" ]; then
            python << 'EOF'
            try:
                with open('requirements.txt', 'r', encoding='utf-16') as f:
                    content = f.read()
                with open('requirements.txt', 'w', encoding='utf-8') as f:
                    f.write(content)
                print('âœ… æ–‡ä»¶ç¼–ç è½¬æ¢æˆåŠŸ')
            except UnicodeDecodeError:
                print('â„¹ï¸ æ–‡ä»¶å·²ä¸ºUTF-8ç¼–ç ')
            except Exception as e:
                print(f'âš ï¸ ç¼–ç è½¬æ¢è­¦å‘Š: {e}')
          EOF
          else
            echo "âš ï¸ requirements.txt ä¸å­˜åœ¨"
          fi
          
          # è¿‡æ»¤PyTorchåŒ…
          grep -Ev "^(torch|torchvision|torchaudio)" requirements.txt > requirements.ci.txt || true
          
          # å®‰è£…CPUç‰ˆæœ¬PyTorch
          pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu
          
          # å®‰è£…é¡¹ç›®ä¾èµ–
          pip install -r requirements.ci.txt
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: âš™ï¸ é…ç½®ç¯å¢ƒå˜é‡
        run: |
          cat > .env << EOF
          CELERY_BROKER_URL=redis://localhost:6379/0
          CELERY_RESULT_BACKEND=redis://localhost:6379/0
          EOF
          echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

      - name: ğŸ” Django ç³»ç»Ÿæ£€æŸ¥
        run: |
          python manage.py check --settings=SkillSpace.settings_test
          echo "âœ… ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"

      - name: ğŸ—„ï¸ æ•°æ®åº“è¿ç§»
        run: |
          python manage.py migrate --settings=SkillSpace.settings_test --verbosity=2
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          # æ³¨å…¥ç¯å¢ƒå˜é‡æ§åˆ¶æ¨¡å‹æµ‹è¯•
          export SKIP_MODEL_TESTS=${{ env.SKIP_MODEL_TESTS }}
          python manage.py test --settings=SkillSpace.settings_test --verbosity=2
          echo "âœ… æµ‹è¯•å®Œæˆ"