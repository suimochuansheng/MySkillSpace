# ========================================
# SkillSpace è½»é‡çº§ CI (Lite Version)
# ç›®æ ‡ï¼šå¿«é€ŸéªŒè¯æ„å»ºå’ŒåŸºæœ¬é€»è¾‘ï¼Œä¸æµªè´¹æ—¶é—´
# ========================================

name: SkillSpace Lite CI

on:
  push:
    branches: [ "main", "hotfix/*" ]
  pull_request:
    branches: [ "main", "feature/*" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '20'

jobs:
  # ============================
  # ä»»åŠ¡1ï¼šå‰ç«¯æ„å»ºæ£€æŸ¥
  # ============================
  frontend-build:
    name: å‰ç«¯æ„å»º (Vue 3)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/skillspace
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json

      - name: ğŸ“¦ å®‰è£…å¹¶æ„å»º
        run: |
          # å¿«é€Ÿå®‰è£…ä¾èµ–
          npm ci --prefer-offline --no-audit
          # å°è¯•æ„å»ºç”Ÿäº§ç‰ˆæœ¬
          npm run build

  # ============================
  # ä»»åŠ¡2ï¼šåç«¯ä»£ç æ£€æŸ¥
  # ============================
  backend-check:
    name: åç«¯æ£€æŸ¥ (SQLite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…è½»é‡ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          
          # 1. ç®€æ˜“ç¼–ç ä¿®å¤ (é˜²æ­¢ Windows UTF-16 æŠ¥é”™)
          python -c "try: c=open('requirements.txt','r',encoding='utf-16').read(); open('requirements.txt','w',encoding='utf-8').write(c); print('âœ… UTF-16è½¬UTF-8æˆåŠŸ'); except: pass"

          # 2. è¿‡æ»¤æ‰ PyTorch (èŠ‚çœ 3-5 åˆ†é’Ÿä¸‹è½½æ—¶é—´)
          # æ³¨æ„ï¼šå¦‚æœä½ çš„ä»£ç  import torch ä¼šæŠ¥é”™ï¼Œè¯·æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œ grep
          grep -Ev "^(torch|torchvision|torchaudio)" requirements.txt > requirements.lite.txt

          # 3. å®‰è£…ä¸šåŠ¡ä¾èµ–
          pip install -r requirements.lite.txt
          
          # 4. è¡¥å……å®‰è£… pymysql (é˜²æ­¢ settings.py æŠ¥é”™)
          pip install pymysql

      - name: ğŸ§ª è¿è¡Œå¿«é€Ÿæ£€æŸ¥
        run: |
          # ä¸´æ—¶æ³¨å…¥ pymysql é©±åŠ¨ (é˜²æ­¢ Django å¯åŠ¨æŠ¥é”™)
          sed -i '1i import pymysql\npymysql.install_as_MySQLdb()' SkillSpace/settings.py
          
          # è®¾ç½®åŸºæœ¬å¯†é’¥ (ä¸è®¾ç½® DB å˜é‡ï¼Œé»˜è®¤ä½¿ç”¨ SQLite)
          export SECRET_KEY='ci-lite-test-key'
          
          echo "ğŸ” æ£€æŸ¥ä»£ç é…ç½®..."
          python manage.py check
          
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯• (SQLite)..."
          # ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œé€Ÿåº¦æå¿«
          python manage.py test