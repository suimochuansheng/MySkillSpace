# ========================================
# SkillSpace é¡¹ç›® CI/CD é…ç½®
# ç›®æ ‡ï¼šå»ºç«‹ç¨³å®šå¯é çš„åŸºç¡€æµ‹è¯•æµç¨‹
# ========================================

name: SkillSpace CI Pipeline

# ========================================
# è§¦å‘æ¡ä»¶
# ========================================
on:
  push:
    branches: [ "main", "hotfix/*" ]
  pull_request:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  workflow_dispatch:

# ========================================
# å…¨å±€çŽ¯å¢ƒå˜é‡
# ========================================
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '20'
  FRONTEND_BUILD_DIR: frontend/skillspace/dist
  # æ–°å¢žï¼šæ¨¡åž‹æµ‹è¯•æ ‡è®°
  SKIP_MODEL_TESTS: "true"  # CIçŽ¯å¢ƒé»˜è®¤è·³è¿‡æ¨¡åž‹åŠ è½½æµ‹è¯•
  # Django æµ‹è¯•é…ç½®
  DJANGO_SETTINGS_MODULE: "SkillSpace.settings"
  SECRET_KEY: "ci-test-secret-key-123456"
  # MySQL é…ç½®
  MYSQL_ROOT_PASSWORD: "ci-mysql-root-123"
  MYSQL_DATABASE: "skillspace_test"
  MYSQL_USER: "ci_user"
  MYSQL_PASSWORD: "ci_pass_123"
  # Celery æµ‹è¯•å…³é”®é…ç½®ï¼ˆåŒæ­¥æ‰§è¡Œä»»åŠ¡ï¼Œæ— éœ€å¯åŠ¨workerï¼‰
  CELERY_TASK_ALWAYS_EAGER: "True"
  CELERY_TASK_EAGER_PROPAGATES: "True"

# ========================================
# ä½œä¸šå®šä¹‰
# ========================================
jobs:
  frontend-test-build:
    name: å‰ç«¯æµ‹è¯•ä¸Žæž„å»º (Vue 3 + Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/skillspace
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ðŸ› ï¸ Vite æž„å»ºæ£€æŸ¥
        run: |
          echo "å¼€å§‹æž„å»º..."
          npm run build
          echo "âœ… æž„å»ºæˆåŠŸ"
      
      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 7
          if-no-files-found: error

  backend-test:
    name: åŽç«¯æµ‹è¯• (Django + MySQL + Redis + Celery)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    # è¡¥å…… MySQL æœåŠ¡ï¼ˆDjango ä¾èµ–ï¼Œä¹‹å‰é—æ¼ï¼‰
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -u root -p$MYSQL_ROOT_PASSWORD"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # ç¼“å­˜ pipï¼Œä½†åŸºäºŽè™šæ‹ŸçŽ¯å¢ƒè·¯å¾„ï¼ˆé¿å…ä¸Žç³»ç»Ÿä¾èµ–å†²çªï¼‰
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆMySQLå®¢æˆ·ç«¯ã€ç¼–è¯‘ä¾èµ–ï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends \
            mysql-client \
            redis-tools \
            gcc \
            python3-dev \
            default-libmysqlclient-dev
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: ðŸ› ï¸ åˆ›å»ºå¹¶æ¿€æ´» Python è™šæ‹ŸçŽ¯å¢ƒï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
        run: |
          # åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒï¼ˆæ”¾åœ¨backendç›®å½•ä¸‹ï¼Œä¾¿äºŽç¼“å­˜ï¼‰
          python -m venv .venv
          # æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒï¼ˆLinux/macOS ç”¨ sourceï¼ŒWindows ç”¨ .venv\Scripts\activateï¼‰
          source .venv/bin/activate
          # éªŒè¯è™šæ‹ŸçŽ¯å¢ƒç”Ÿæ•ˆï¼ˆè¾“å‡ºå½“å‰Pythonè·¯å¾„ï¼‰
          echo "å½“å‰Pythonè·¯å¾„: $(which python)"
          echo "å½“å‰pipè·¯å¾„: $(which pip)"
          # å‡çº§pip
          pip install --upgrade pip
          echo "âœ… è™šæ‹ŸçŽ¯å¢ƒé…ç½®å®Œæˆ"

      - name: ðŸ“¦ å¤„ç†ä¾èµ–æ–‡ä»¶å¹¶å®‰è£…ï¼ˆæ•´åˆåˆ°è™šæ‹ŸçŽ¯å¢ƒï¼‰
        run: |
          source .venv/bin/activate  # æ¯æ¬¡stepéƒ½è¦æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒï¼
          
          # ç¼–ç è½¬æ¢ï¼šå°è¯•UTF-16è½¬UTF-8ï¼Œå¤±è´¥åˆ™è·³è¿‡
          if [ -f "requirements.txt" ]; then
            python -c "try:
              with open('requirements.txt', 'r', encoding='utf-16') as f: content = f.read()
              with open('requirements.txt', 'w', encoding='utf-8') as f: f.write(content)
              print('âœ… æ–‡ä»¶ç¼–ç è½¬æ¢æˆåŠŸ')
            except UnicodeDecodeError:
              print('â„¹ï¸ æ–‡ä»¶å·²ä¸ºUTF-8ç¼–ç ')
            except Exception as e:
              print(f'âš ï¸ ç¼–ç è½¬æ¢è­¦å‘Š: {e}')" || echo "ç¼–ç è½¬æ¢è·³è¿‡"
          else
            echo "âŒ requirements.txt ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          
          # è¿‡æ»¤PyTorchåŒ…ï¼ˆç”ŸæˆCIä¸“ç”¨ä¾èµ–æ–‡ä»¶ï¼‰
          grep -Ev "^(torch|torchvision|torchaudio)" requirements.txt > requirements.ci.txt || {
            echo "âš ï¸ è¿‡æ»¤PyTorchå¤±è´¥ï¼Œä½¿ç”¨åŽŸrequirements.txt"
            cp requirements.txt requirements.ci.txt
          }
          
          # å®‰è£…CPUç‰ˆæœ¬PyTorchï¼ˆä¼˜å…ˆäºŽé¡¹ç›®ä¾èµ–ï¼Œé¿å…ç‰ˆæœ¬å†²çªï¼‰
          pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu
          
          # å®‰è£…é¡¹ç›®æ ¸å¿ƒä¾èµ–ï¼ˆè™šæ‹ŸçŽ¯å¢ƒå†…ï¼‰
          pip install -r requirements.ci.txt
          
          # éªŒè¯å…³é”®åŒ…å®‰è£…
          pip list | grep -E "django|djangorestframework|celery|redis|pymysql"
          echo "âœ… é¡¹ç›®ä¾èµ–å®‰è£…å®Œæˆ"

      - name: â³ ç­‰å¾… MySQL/Redis æœåŠ¡å°±ç»ª
        run: |
          source .venv/bin/activate
          # ç­‰å¾…MySQL
          until mysql -h 127.0.0.1 -u root -p"${MYSQL_ROOT_PASSWORD}" -e "SELECT 1"; do
            echo "ç­‰å¾…MySQLæœåŠ¡å¯åŠ¨..."; sleep 2
          done
          # ç­‰å¾…Redis
          until redis-cli ping; do
            echo "ç­‰å¾…RedisæœåŠ¡å¯åŠ¨..."; sleep 2
          done
          # ç¡®ä¿æµ‹è¯•æ•°æ®åº“å­˜åœ¨
          mysql -h 127.0.0.1 -u root -p"${MYSQL_ROOT_PASSWORD}" -e "CREATE DATABASE IF NOT EXISTS ${MYSQL_DATABASE};"
          echo "âœ… æ‰€æœ‰ä¾èµ–æœåŠ¡å°±ç»ª"

      - name: âš™ï¸ ç”ŸæˆçŽ¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆé€‚é…Djangoé…ç½®ï¼‰
        run: |
          source .venv/bin/activate
          cat > .env << 'ENVEOF'
          # æ•°æ®åº“é…ç½®
          DATABASE_URL=mysql+pymysql://${{ env.MYSQL_USER }}:${{ env.MYSQL_PASSWORD }}@127.0.0.1:3306/${{ env.MYSQL_DATABASE }}
          # Redis/Celery é…ç½®
          CELERY_BROKER_URL=redis://127.0.0.1:6379/0
          CELERY_RESULT_BACKEND=redis://127.0.0.1:6379/0
          # æµ‹è¯•æ ‡è®°
          SKIP_MODEL_TESTS=${{ env.SKIP_MODEL_TESTS }}
          ENVEOF
          cat .env  # æ‰“å°éªŒè¯
          echo "âœ… çŽ¯å¢ƒå˜é‡æ–‡ä»¶ç”Ÿæˆå®Œæˆ"

      - name: ðŸ” Django ç³»ç»Ÿæ£€æŸ¥
        run: |
          source .venv/bin/activate
          python manage.py check --settings=${{ env.DJANGO_SETTINGS_MODULE }}
          echo "âœ… Django ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"

      - name: ðŸ—„ï¸ æ•°æ®åº“è¿ç§»ï¼ˆæµ‹è¯•çŽ¯å¢ƒï¼‰
        run: |
          source .venv/bin/activate
          python manage.py migrate --settings=${{ env.DJANGO_SETTINGS_MODULE }} --verbosity=2
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

      - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆå«DRF/Celeryï¼‰
        run: |
          source .venv/bin/activate
          # æ³¨å…¥çŽ¯å¢ƒå˜é‡
          export SECRET_KEY=${{ env.SECRET_KEY }}
          export CELERY_TASK_ALWAYS_EAGER=${{ env.CELERY_TASK_ALWAYS_EAGER }}
          export CELERY_TASK_EAGER_PROPAGATES=${{ env.CELERY_TASK_EAGER_PROPAGATES }}
          # æ‰§è¡Œæµ‹è¯•ï¼ˆè·³è¿‡æ¨¡åž‹æµ‹è¯•ï¼‰
          python manage.py test --settings=${{ env.DJANGO_SETTINGS_MODULE }} --verbosity=2 -k "not model_test"
          echo "âœ… åŽç«¯æµ‹è¯•å…¨éƒ¨å®Œæˆ"