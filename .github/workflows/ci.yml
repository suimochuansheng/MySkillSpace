# ========================================
# SkillSpace é¡¹ç›® CI/CD é…ç½®
# ç›®æ ‡ï¼šå»ºç«‹ç¨³å®šå¯é çš„åŸºç¡€æµ‹è¯•æµç¨‹
# ========================================

name: SkillSpace CI Pipeline

# ========================================
# è§¦å‘æ¡ä»¶
# ========================================
on:
  push:
    branches: [ "main", "hotfix/*" ]
  pull_request:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  workflow_dispatch:

# ========================================
# å…¨å±€çŽ¯å¢ƒå˜é‡
# ========================================
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '20'
  FRONTEND_BUILD_DIR: frontend/skillspace/dist
  # æ–°å¢žï¼šæ¨¡åž‹æµ‹è¯•æ ‡è®°
  SKIP_MODEL_TESTS: "true"  # CIçŽ¯å¢ƒé»˜è®¤è·³è¿‡æ¨¡åž‹åŠ è½½æµ‹è¯•

# ========================================
# ä½œä¸šå®šä¹‰
# ========================================
jobs:
  frontend-test-build:
    name: å‰ç«¯æµ‹è¯•ä¸Žæž„å»º (Vue 3 + Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/skillspace
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ðŸ› ï¸ Vite æž„å»ºæ£€æŸ¥
        run: |
          echo "å¼€å§‹æž„å»º..."
          npm run build
          echo "âœ… æž„å»ºæˆåŠŸ"
      
      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 7
          if-no-files-found: error

  backend-test:
    name: åŽç«¯æµ‹è¯• (Django + settings.py)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ðŸ“¦ å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆä¼˜å…ˆç¡®ä¿Djangoå®‰è£…ï¼‰
        run: |
          python -m pip install --upgrade pip
      
          # å¼ºåˆ¶å®‰è£…é¡¹ç›®æ ¸å¿ƒä¾èµ–ï¼ˆè¦†ç›–settingsä¸­å¯¼å…¥çš„æ‰€æœ‰æ¨¡å—ï¼‰
          pip install \
            django>=4.2.0 \
            djangorestframework>=3.14.0 \
            pymysql>=1.1.0 \
            redis>=4.5.0 \
            celery>=5.3.0 \
            requests>=2.31.0

          # ç¼–ç è½¬æ¢ï¼šå°è¯•UTF-16è½¬UTF-8ï¼Œå¤±è´¥åˆ™è·³è¿‡
          if [ -f "requirements.txt" ]; then
            python -c "try:\n  with open('requirements.txt', 'r', encoding='utf-16') as f: content = f.read()\n  with open('requirements.txt', 'w', encoding='utf-8') as f: f.write(content)\n  print('âœ… æ–‡ä»¶ç¼–ç è½¬æ¢æˆåŠŸ')\nexcept UnicodeDecodeError:\n  print('â„¹ï¸ æ–‡ä»¶å·²ä¸ºUTF-8ç¼–ç ')\nexcept Exception as e:\n  print(f'âš ï¸ ç¼–ç è½¬æ¢è­¦å‘Š: {e}')" || echo "ç¼–ç è½¬æ¢è·³è¿‡"
          else
            echo "âš ï¸ requirements.txt ä¸å­˜åœ¨"
          fi
          
          # è¿‡æ»¤PyTorchåŒ…
          grep -Ev "^(torch|torchvision|torchaudio)" requirements.txt > requirements.ci.txt || true
          
          # å®‰è£…CPUç‰ˆæœ¬PyTorch
          pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu
          
          # å®‰è£…é¡¹ç›®ä¾èµ–
          pip install -r requirements.ci.txt
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: âš™ï¸ é…ç½®çŽ¯å¢ƒå˜é‡
        run: |
          cat > .env << 'ENVEOF'
          CELERY_BROKER_URL=redis://localhost:6379/0
          CELERY_RESULT_BACKEND=redis://localhost:6379/0
          ENVEOF
          echo "âœ… çŽ¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

      - name: ðŸ” Django ç³»ç»Ÿæ£€æŸ¥
        run: |
          python manage.py check --settings=SkillSpace.settings
          echo "âœ… ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"

      - name: ðŸ—„ï¸ æ•°æ®åº“è¿ç§»
        run: |
          python manage.py migrate --settings=SkillSpace.settings --verbosity=2
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

      - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          # æ³¨å…¥çŽ¯å¢ƒå˜é‡æŽ§åˆ¶æ¨¡åž‹æµ‹è¯•
          export SKIP_MODEL_TESTS=${{ env.SKIP_MODEL_TESTS }}
          python manage.py test --settings=SkillSpace.settings --verbosity=2
          echo "âœ… æµ‹è¯•å®Œæˆ"