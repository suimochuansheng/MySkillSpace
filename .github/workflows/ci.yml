# CI 代码检查工作流
name: CI代码检查

# 触发条件：指定分支的推送/拉取请求操作
on:
  push:
    branches: [ "main", "master", "dev" ]  # 推送代码至这些分支时触发
  pull_request:
    branches: [ "main", "master" ]         # 针对这些分支创建PR时触发

# 定义代码检查任务
jobs:
  代码规范检查:
    runs-on: ubuntu-latest  # 运行环境：最新版Ubuntu系统
    steps:
    # 步骤1：检出仓库代码
    - uses: actions/checkout@v4

    # 步骤2：配置Python运行环境
    - name: 配置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'  # 指定Python版本为3.10

    # 步骤3：安装代码检查工具
    - name: 安装代码检查工具
      # 优化：仅安装轻量级检查工具，跳过requirements.txt中的torch等重量级依赖，大幅节省耗时
      run: |
        pip install flake8 isort black

    # 步骤4：运行Black检查代码格式
    - name: 检查代码格式（Black）
      # 作用：校验代码是否符合Black格式规范，仅检查不自动修改
      run: black --check .

    # 步骤5：运行Isort检查导入语句
    - name: 检查导入顺序（Isort）
      # 作用：校验导包语句排序是否规范，适配Black格式配置，仅检查不修改
      run: isort --check-only --profile black .

    # 步骤6：运行Flake8检测代码错误
    - name: 检测代码错误（Flake8）
      # 优化说明：
      # 1. 忽略非关键格式错误（E501=行过长、W503=换行符位置）
      # 2. 排除迁移文件、虚拟环境、settings.py等无需检查的文件
      # 3. 限制代码最大复杂度为10，最大行长度为127
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --max-complexity=10 --max-line-length=127 --ignore=E501,W503 --exclude=*/migrations/*,venv,env,settings.py --statistics