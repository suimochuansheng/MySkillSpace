# ========================================
# SkillSpace é¡¹ç›® CI/CD é…ç½®
# ç›®æ ‡ï¼šè½»é‡çº§ã€å¿«é€Ÿã€ç¨³å®šçš„åŸºç¡€æµ‹è¯•æµç¨‹
# ========================================

name: SkillSpace CI Pipeline

# ========================================
# è§¦å‘æ¡ä»¶
# ========================================
on:
  push:
    branches: [ "main", "hotfix/*" ]
  pull_request:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  workflow_dispatch:

# ========================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ========================================
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '20'
  FRONTEND_BUILD_DIR: frontend/skillspace/dist

# ========================================
# ä½œä¸šå®šä¹‰
# ========================================
jobs:
  frontend-test-build:
    name: å‰ç«¯æµ‹è¯•ä¸æ„å»º (Vue 3 + Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/skillspace
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/skillspace/package-lock.json

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ› ï¸ Vite æ„å»ºæ£€æŸ¥
        run: |
          echo "å¼€å§‹æ„å»º..."
          npm run build
          echo "âœ… æ„å»ºæˆåŠŸ"
      
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 7
          if-no-files-found: error

  backend-test:
    name: åç«¯æµ‹è¯• (Django + SQLite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          # ç›´æ¥å®‰è£…ä¾èµ–ï¼Œä¸è¿‡æ»¤ PyTorchï¼ˆå¦‚éœ€è¦å¯æ‰‹åŠ¨è°ƒæ•´ï¼‰
          pip install -r requirements.txt || {
            echo "âš ï¸ å®Œæ•´å®‰è£…å¤±è´¥ï¼Œå°è¯•å®‰è£…æ ¸å¿ƒä¾èµ–"
            pip install django djangorestframework djangorestframework-simplejwt django-cors-headers PyMySQL
          }
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ” ä»£ç è§„èŒƒæ£€æŸ¥
        run: |
          # å®‰è£…ä»£ç æ£€æŸ¥å·¥å…·
          pip install flake8 || echo "âš ï¸ flake8 å®‰è£…å¤±è´¥ï¼Œè·³è¿‡ä»£ç è§„èŒƒæ£€æŸ¥"
          # æ‰§è¡Œæ£€æŸ¥ï¼ˆå¿½ç•¥è¿ç§»æ–‡ä»¶å’Œè™šæ‹Ÿç¯å¢ƒï¼‰
          flake8 . --exclude=migrations,venv,.venv --max-line-length=120 --ignore=E501,W503 || echo "âš ï¸ ä»£ç è§„èŒƒæ£€æŸ¥å‘ç°é—®é¢˜ï¼ˆéé˜»æ–­ï¼‰"

      - name: ğŸ” Django ç³»ç»Ÿæ£€æŸ¥
        run: |
          python manage.py check
          echo "âœ… Django ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"

      - name: ğŸ—„ï¸ æ•°æ®åº“è¿ç§»ï¼ˆSQLiteï¼‰
        run: |
          # ä½¿ç”¨ SQLite å†…å­˜æ•°æ®åº“ï¼Œæ— éœ€é¢å¤–é…ç½®
          python manage.py migrate --verbosity=2
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          # è¿è¡Œæ‰€æœ‰æµ‹è¯•
          python manage.py test --verbosity=2
          echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
