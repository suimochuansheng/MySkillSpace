name: æ‰‹åŠ¨éƒ¨ç½² - æ„å»ºå¹¶æ¨é€é•œåƒ

# è§¦å‘æ¡ä»¶ï¼šä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
# ç”¨é€”ï¼šç”¨äºç‰¹æ®Šåœºæ™¯ä¸‹çš„æ‰‹åŠ¨æ„å»ºå’Œæ¨é€ï¼ˆå¦‚çƒ­ä¿®å¤ã€å›æ»šç­‰ï¼‰
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ç›®æ ‡ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  # é•œåƒç‰ˆæœ¬å·ï¼ˆä½¿ç”¨ Git commit SHA çŸ­ç ï¼‰
  IMAGE_TAG: ${{ github.sha }}
  # ä» GitHub Secrets è¯»å– ACR é…ç½®
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° ACR
    runs-on: ubuntu-latest

    steps:
      # ==================== 0. è°ƒè¯• - éªŒè¯ Secrets ====================
      - name: è°ƒè¯• - éªŒè¯ Secrets é…ç½®
        run: |
          echo "========================================="
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - éªŒè¯ Secrets"
          echo "========================================="
          echo "ACR_REGISTRY æ˜¯å¦ä¸ºç©º: ${{ secrets.ACR_REGISTRY == '' }}"
          echo "ACR_USERNAME æ˜¯å¦ä¸ºç©º: ${{ secrets.ACR_USERNAME == '' }}"
          echo "ACR_PASSWORD æ˜¯å¦ä¸ºç©º: ${{ secrets.ACR_PASSWORD == '' }}"
          echo "ACR_REGISTRY é•¿åº¦: ${#ACR_REGISTRY}"
          echo "========================================="
          if [ -z "${{ secrets.ACR_REGISTRY }}" ]; then
            echo "âŒ é”™è¯¯ï¼šACR_REGISTRY Secret æœªé…ç½®æˆ–ä¸ºç©ºï¼"
            exit 1
          fi
          if [ -z "${{ secrets.ACR_USERNAME }}" ]; then
            echo "âŒ é”™è¯¯ï¼šACR_USERNAME Secret æœªé…ç½®æˆ–ä¸ºç©ºï¼"
            exit 1
          fi
          if [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
            echo "âŒ é”™è¯¯ï¼šACR_PASSWORD Secret æœªé…ç½®æˆ–ä¸ºç©ºï¼"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰å¿…éœ€çš„ ACR Secrets éƒ½å·²é…ç½®"

      # ==================== 1. æ£€å‡ºä»£ç  ====================
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ==================== 2. è®¾ç½® Docker Buildx ====================
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ==================== 3. ç™»å½•é˜¿é‡Œäº‘ ACR ====================
      - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ==================== 4. æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ ====================
      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/backend:latest
            ${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/backend:latest
          cache-to: type=inline

      # ==================== 5. æ„å»ºå¹¶æ¨é€ Celery Worker é•œåƒ ====================
      - name: æ„å»ºå¹¶æ¨é€ Celery Worker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/celery_worker:latest
            ${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/celery_worker:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/celery_worker:latest
          cache-to: type=inline

      # ==================== 6. æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ ====================
      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/skillspace
          file: ./frontend/skillspace/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/frontend:latest
            ${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/frontend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/${{secrets.ACR_NAMESPACE}}/frontend:latest
          cache-to: type=inline

      # ==================== 7. è¾“å‡ºæ„å»ºä¿¡æ¯ ====================
      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        run: |
          echo "========================================="
          echo "âœ… æ‰‹åŠ¨æ„å»ºå®Œæˆï¼é•œåƒå·²æ¨é€åˆ° ACR"
          echo "========================================="
          echo "ğŸ¯ ç›®æ ‡ç¯å¢ƒ: ${{ github.event.inputs.environment }}"
          echo ""
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾ï¼š"
          echo "  - backend:latest"
          echo "  - backend:${{ github.sha }}"
          echo "  - celery_worker:latest"
          echo "  - celery_worker:${{ github.sha }}"
          echo "  - frontend:latest"
          echo "  - frontend:${{ github.sha }}"
          echo ""
          echo "========================================="
          echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
          echo "1. SSH è¿æ¥åˆ° ECS æœåŠ¡å™¨"
          echo "2. æ‰§è¡Œ: cd /app/skillspace"
          echo "3. æ‰§è¡Œ: docker compose -f docker-compose.prod.yml pull"
          echo "4. æ‰§è¡Œ: docker compose -f docker-compose.prod.yml up -d"
          echo ""
          echo "ğŸ’¡ æç¤ºï¼šä¹Ÿå¯ä»¥é€šè¿‡ cd.yml å·¥ä½œæµè‡ªåŠ¨éƒ¨ç½²"
          echo "========================================="
