# ==================== 生产环境 Docker Compose ====================

# 用途：在 Debian13 虚拟机上部署完整的 SkillSpace 项目

# 使用本地构建的镜像（不依赖镜像仓库）

# V2 版本不需要 version: '3.8'

services:

  # ==================== 1. 前端服务（Nginx + Vue） ====================

  frontend:
    image: ${ALI_PUBLIC_HOST}/${ACR_NAMESPACE}/frontend:latest
    container_name: skillspace_frontend
    restart: always
    ports:
      - "80:80"  # HTTP端口
      # - "443:443"  # HTTPS端口（如果配置SSL）
    depends_on:
      - backend
    networks:
      - skillspace_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== 2. 后端服务（Django + Daphne） ====================

  backend:
    image: ${ALI_PUBLIC_HOST}/${ACR_NAMESPACE}/backend:latest
    container_name: skillspace_backend
    restart: always
    depends_on:
      - db
      - redis
      - rabbitmq
    env_file:
      - .env  # 使用生产环境变量文件
    ports:
      - "8000:8000"  # 仅供内部访问，外部通过Nginx代理
    volumes:
      - static_volume:/app/SkillSpace/staticfiles  # 静态文件
      - media_volume:/app/SkillSpace/media  # 用户上传文件
    networks:
      - skillspace_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== 3. Celery Worker（异步任务处理） ====================

  celery_worker:
    image: ${ALI_PUBLIC_HOST}/${ACR_NAMESPACE}/celery_worker:latest
    container_name: skillspace_celery_worker
    restart: always
    command: celery -A SkillSpace worker --loglevel=info --concurrency=2
    depends_on:
      - db
      - redis
      - rabbitmq
    env_file:
      - .env  # 使用生产环境变量文件
    volumes:
      - media_volume:/app/SkillSpace/media
    networks:
      - skillspace_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== 4. MySQL 数据库 ====================

  db:
    image: mysql:8.0
    container_name: skillspace_db
    restart: always
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    env_file:
      - .env
    environment:
      - MYSQL_ROOT_PASSWORD=${ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - TZ=Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d  # 初始化脚本（可选）
    networks:
      - skillspace_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== 5. Redis 缓存 ====================

  redis:
    image: redis:7.0-alpine
    container_name: skillspace_redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    env_file:
      - .env
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - skillspace_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==================== 6. RabbitMQ 消息队列 ====================

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: skillspace_rabbitmq
    restart: always
    env_file:
      - .env
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    ports:
      - "5672:5672"  # AMQP协议端口
      - "15672:15672"  # 管理后台
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - skillspace_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==================== 数据卷（持久化存储） ====================

volumes:
  mysql_data:  # MySQL数据
  redis_data:  # Redis数据
  rabbitmq_data:  # RabbitMQ数据
  static_volume:  # Django静态文件
  media_volume:  # 用户上传文件

# ==================== 网络配置 ====================

networks:
  skillspace_network:
    driver: bridge
